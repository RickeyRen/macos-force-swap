# macOS 强制使用Swap工具

这是一个专门设计用于绕过macOS内存压缩优化，强制使用swap的工具。与普通内存分配工具不同，这个工具使用了多种技术确保内存真正写入swap文件。

## 编译

```bash
gcc -o force_swap force_swap.c
```

## 使用方法

```bash
./force_swap [-p percentage] [-c chunk_size_mb] [-s sleep_interval] [-r rounds] [-l lock_enforce]
```

### 参数说明

- `-p percentage`: 要分配的物理内存百分比（默认：300%）
- `-c chunk_size_mb`: 每次分配的内存块大小（MB）（默认：128MB）
- `-s sleep_interval`: 每次分配后的休眠间隔（秒）（默认：0秒）
- `-r rounds`: 内存回收和重新分配的轮数（默认：5轮）
- `-l lock_enforce`: 是否启用内存锁定防止压缩（默认：1启用）
- `-h`: 显示帮助信息

### 示例

1. 使用默认参数：
   ```bash
   ./force_swap
   ```

2. 分配200%的物理内存，每次64MB，3轮：
   ```bash
   ./force_swap -p 200 -c 64 -r 3
   ```

3. 分配400%的物理内存，禁用锁定，10轮：
   ```bash
   ./force_swap -p 400 -l 0 -r 10
   ```

## 与普通内存占用工具的区别

这个工具专门设计用于绕过macOS的内存优化机制：

1. **使用mmap而非malloc**：更直接地控制内存分配
2. **随机数据填充**：为每个内存页生成随机数据，降低压缩效率
3. **强制页面驱逐**：使用MADV_PAGEOUT主动将页面驱逐到swap
4. **多轮分配**：通过释放和重新分配内存，增加swap使用概率
5. **实时监控**：显示swap使用量的实时变化

## 技术细节

工具使用了以下技术来强制使用swap：

- **MAP_NORESERVE标志**：告诉系统不预留交换空间
- **madvise**：使用MADV_PAGEOUT提示系统将页面移到swap
- **页面级随机数据**：每个内存页填充不同的随机数据，避免内存压缩将相似页面合并
- **内存锁定**：可选地使用mlockall防止重要内存被交换

## 注意事项

- 此工具会导致系统严重变慢，使用时请确保保存重要工作
- 可能需要root权限才能使用某些内存管理功能
- 大量使用swap可能导致系统磁盘空间占用增加
- 程序会在无法分配更多内存时自动停止
- 按Enter键释放所有占用的内存并退出程序 